{% extends "base.html" %}
{% block content %}

<h1 class="page-title">Welcome to BookinFly</h1>

<!-- Flight Search Form -->
<form method="post" action="{% url 'home' %}" class="card search-form">
    {% csrf_token %}
    <fieldset>
        <legend>Search Available Flights</legend>
        {{ form.as_p }}
        <button type="submit" class="btn">Search</button>
    </fieldset>
</form>

{% if search_results is not None %}
    <h2 class="section-title">Search Results</h2>
    {% if search_results %}
        <div class="table-wrap">
            <table class="flight-table">
                <thead>
                  <tr>
                      <th>From</th>
                      <th>To</th>
                      <th>Departure</th>
                      <th>Arrival</th>
                      <th>Price</th>
                      <th>Seats Left</th>
                      <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                {% for flight in search_results %}
                <tr>
                    <td>{{ flight.departure }}</td>
                    <td>{{ flight.destination }}</td>
                    <td>{{ flight.departure_time|date:"D M d, Y H:i" }}</td>
                    <td>{{ flight.arrival_time|date:"D M d, Y H:i" }}</td>
                    <td>{{ flight.discounted_price|default:flight.original_price }}</td>
                    <td>{{ flight.available_seats }}</td>
                    <td>
                        {% if user.is_authenticated %}
                            <a class="btn btn-compact" href="{% url 'seat_selection' flight.id %}">Book</a>
                        {% else %}
                            <a class="btn btn-compact" href="{% url 'login' %}?next={% url 'seat_selection' flight.id %}">Login to Book</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="muted">No flights match your search.</p>
    {% endif %}
{% endif %}

<!-- Notices -->
<hr class="soft">
<h2 class="section-title">Latest Notices</h2>
<ul class="notice-list card">
    {% for notice in notices %}
        <li><strong>{{ notice.title }}:</strong> {{ notice.message }}</li>
    {% empty %}
        <li>No current notices.</li>
    {% endfor %}
</ul>

<!-- Frequent Trips & Last Travelled -->
{% if user.is_authenticated %}
<hr class="soft">
<div class="dashboard-trips">

  <!-- Frequent Trips -->
  <div class="trips-card">
    <h2 class="section-title">Frequently Travelled</h2>
    {% if frequent_flights %}
      <div class="trips-grid">
        {% for flight in frequent_flights %}
        <div class="trip-item">
          <span class="trip-route">{{ flight.departure }} → {{ flight.destination }}</span>
          <span class="trip-date">{{ flight.departure_time|date:"M d, Y" }}</span>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No frequent travel history yet.</p>
    {% endif %}
  </div>

  <!-- Last Travelled Flight -->
  <div class="trips-card">
    <h2 class="section-title">Last Travelled Flight</h2>
    {% if last_flight %}
      <div class="trip-item last-flight">
        <span class="trip-route">{{ last_flight.departure }} → {{ last_flight.destination }}</span>
        <span class="trip-date">{{ last_flight.departure_time|date:"M d, Y" }}</span>
      </div>
    {% else %}
      <p class="muted">You haven’t travelled yet.</p>
    {% endif %}
  </div>

</div>
{% endif %}

{% endblock %}
